(()=>{"use strict";var t={533:(t,e,s)=>{const i=s(338),r=s(494),n=s(997),h=s(158);t.exports=class{constructor(t,e,s,h,o,a=3){this.x=t,this.y=e,this.width=s,this.height=h,this.speed=0,this.acceleration=.2,this.maxSpeed=a,this.friction=.05,this.angle=0,this.damaged=!1,this.useBrain="AI"==o,"DUMMY"!==o&&(this.sensor=new n(this),this.brain=new i([this.sensor.rayCount,6,4])),this.controls=new r(o)}update(t,e){if(this.damaged||(this.move(),this.polygon=this.createPolygon(),this.damaged=this.assessDamage(t,e)),this.sensor){this.sensor.update(t,e);const s=this.sensor.readings.map((t=>null==t?0:1-t.offset)),i=h.networkFeedForward(s,this.brain);this.useBrain&&(this.controls.forward=i[0],this.controls.left=i[1],this.controls.right=i[2],this.controls.reverse=i[3])}}move(){if(this.controls.forward&&(this.speed+=this.acceleration),this.controls.reverse&&(this.speed-=this.acceleration),this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<-this.maxSpeed/2&&(this.speed=-this.maxSpeed/2),this.speed>0&&(this.speed-=this.friction),this.speed<0&&(this.speed+=this.friction),Math.abs(this.speed)<this.friction&&(this.speed=0),0!=this.speed){const t=this.speed>0?1:-1;this.controls.left&&(this.angle+=.03*t),this.controls.right&&(this.angle-=.03*t)}this.x-=Math.sin(this.angle)*this.speed,this.y-=Math.cos(this.angle)*this.speed}assessDamage(t,e){for(let e=0;e<t.length;e++)if(h.polysIntersect(this.polygon,t[e]))return!0;for(let t=0;t<e.length;t++)if(h.polysIntersect(this.polygon,e[t].polygon))return!0;return!1}createPolygon(){const t=[],e=Math.hypot(this.width,this.height)/2,s=Math.atan2(this.width,this.height);return t.push({x:this.x-Math.sin(this.angle-s)*e,y:this.y-Math.cos(this.angle-s)*e}),t.push({x:this.x-Math.sin(this.angle+s)*e,y:this.y-Math.cos(this.angle+s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle-s)*e,y:this.y-Math.cos(Math.PI+this.angle-s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle+s)*e,y:this.y-Math.cos(Math.PI+this.angle+s)*e}),t}draw(t,e,s=!1){this.damaged?t.fillStyle="gray":t.fillStyle=e,t.beginPath(),t.moveTo(this.polygon[0].x,this.polygon[0].y);for(let e=1;e<this.polygon.length;e++)t.lineTo(this.polygon[e].x,this.polygon[e].y);t.fill(),this.sensor&&s&&this.sensor.draw(t)}}},494:t=>{t.exports=class{constructor(t){this.forward=!1,this.left=!1,this.right=!1,this.reverse=!1,"KEYS"===t?this.addKeyboardListeners():"DUMMY"===t&&(this.forward=!0)}addKeyboardListeners(){document.onkeydown=t=>{switch(t.key){case"ArrowLeft":this.left=!0;break;case"ArrowRight":this.right=!0;break;case"ArrowUp":this.forward=!0;break;case"ArrowDown":this.reverse=!0}},document.onkeyup=t=>{switch(t.key){case"ArrowLeft":this.left=!1;break;case"ArrowRight":this.right=!1;break;case"ArrowUp":this.forward=!1;break;case"ArrowDown":this.reverse=!1}}}}},338:(t,e,s)=>{const i=s(158);class r{constructor(t,e){this.inputs=new Array(t),this.outputs=new Array(e),this.biases=new Array(e),this.weights=[];for(let s=0;s<t;s++)this.weights[s]=new Array(e);i.randomize(this)}randomize(t){i.randomize(t)}feedForward(t,e){return i.feedForward(t,e)}}t.exports=class{constructor(t){this.levels=[];for(let e=0;e<t.length-1;e++)this.levels.push(new r(t[e],t[e+1]))}feedForward(t,e){return i.networkFeedForward(t,e)}static mutate(t,e=1){t.levels.forEach((t=>{for(let s=0;s<t.biases.length;s++)t.biases[s]=i.lerp(t.biases[s],2*Math.random()-1,e);for(let s=0;s<t.weights.length;s++)for(let r=0;r<t.weights[s].length;r++)t.weights[s][r]=i.lerp(t.weights[s][r],2*Math.random()-1,e)}))}}},621:(t,e,s)=>{const i=s(158);t.exports=class{constructor(t,e,s=3){this.x=t,this.width=e,this.laneCount=s,this.left=t-e/2,this.right=t+e/2;this.top=-1e6,this.bottom=1e6;const i={x:this.left,y:this.top},r={x:this.right,y:this.top},n={x:this.left,y:this.bottom},h={x:this.right,y:this.bottom};this.borders=[[i,n],[r,h]]}getLaneCenter(t){const e=this.width/this.laneCount;return this.left+e/2+Math.min(t,this.laneCount-1)*e}draw(t){t.lineWidth=5,t.strokeStyle="white";for(let e=1;e<=this.laneCount-1;e++){const s=i.lerp(this.left,this.right,e/this.laneCount);t.setLineDash([20,20]),t.beginPath(),t.moveTo(s,this.top),t.lineTo(s,this.bottom),t.stroke()}t.setLineDash([]),this.borders.forEach((e=>{t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y),t.stroke()}))}}},997:(t,e,s)=>{const i=s(158);t.exports=class{constructor(t){this.car=t,this.rayCount=5,this.rayLength=150,this.raySpread=Math.PI/2,this.rays=[],this.readings=[]}update(t,e){this.castRays(),this.readings=[];for(let s=0;s<this.rays.length;s++)this.readings.push(this.getReading(this.rays[s],t,e))}getReading(t,e,s){let r=[];for(let s=0;s<e.length;s++){const n=i.getIntersection(t[0],t[1],e[s][0],e[s][1]);n&&r.push(n)}for(let e=0;e<s.length;e++){const n=s[e].polygon;for(let e=0;e<n.length;e++){const s=i.getIntersection(t[0],t[1],n[e],n[(e+1)%n.length]);s&&r.push(s)}}if(0==r.length)return null;{const t=r.map((t=>t.offset)),e=Math.min(...t);return r.find((t=>t.offset==e))}}castRays(){this.rays=[];for(let t=0;t<this.rayCount;t++){const e=i.lerp(this.raySpread/2,-this.raySpread/2,1==this.rayCount?.5:t/(this.rayCount-1))+this.car.angle,s={x:this.car.x,y:this.car.y},r={x:this.car.x-Math.sin(e)*this.rayLength,y:this.car.y-Math.cos(e)*this.rayLength};this.rays.push([s,r])}}draw(t){for(let e=0;e<this.rayCount;e++){let s=this.rays[e][1];this.readings[e]&&(s=this.readings[e]),t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[e][0].x,this.rays[e][0].y),t.lineTo(s.x,s.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="black",t.moveTo(this.rays[e][1].x,this.rays[e][1].y),t.lineTo(s.x,s.y),t.stroke()}}}},158:t=>{const e={lerp:function(t,e,s){return t+(e-t)*s},getNodeX:function(t,s,i,r){return e.lerp(i,r,1==t.length?.5:s/(t.length-1))},getIntersection:function(t,s,i,r){const n=(r.x-i.x)*(t.y-i.y)-(r.y-i.y)*(t.x-i.x),h=(i.y-t.y)*(t.x-s.x)-(i.x-t.x)*(t.y-s.y),o=(r.y-i.y)*(s.x-t.x)-(r.x-i.x)*(s.y-t.y);if(0!=o){const i=n/o,r=h/o;if(i>=0&&i<=1&&r>=0&&r<=1)return{x:e.lerp(t.x,s.x,i),y:e.lerp(t.y,s.y,i),offset:i}}return null},polysIntersect:function(t,s){for(let i=0;i<t.length;i++)for(let r=0;r<s.length;r++)if(e.getIntersection(t[i],t[(i+1)%t.length],s[r],s[(r+1)%s.length]))return!0;return!1},feedForward:function(t,e){for(let s=0;s<e.inputs.length;s++)e.inputs[s]=t[s];for(let t=0;t<e.outputs.length;t++){let s=0;for(let i=0;i<e.inputs.length;i++)s+=e.inputs[i]*e.weights[i][t];s>e.biases[t]?e.outputs[t]=1:e.outputs[t]=0}return e.outputs},networkFeedForward:function(t,s){let i=e.feedForward(t,s.levels[0]);for(let t=1;t<s.levels.length;t++)i=e.feedForward(i,s.levels[t]);return i},randomize:function(t){for(let e=0;e<t.inputs.length;e++)for(let s=0;s<t.outputs.length;s++)t.weights[e][s]=2*Math.random()-1;for(let e=0;e<t.biases.length;e++)t.biases[e]=2*Math.random()-1},getRGBA:function(t){const e=t<0?0:255;return"rgba("+e+","+e+","+(t>0?0:255)+","+Math.abs(t)+")"}};t.exports=e},857:(t,e,s)=>{const i=s(158);class r{static drawNetwork(t,e){const s=t.canvas.width-100,n=t.canvas.height-100,h=n/e.levels.length;for(let o=e.levels.length-1;o>=0;o--){const a=50+i.lerp(n-h,0,1==e.levels.length?.5:o/(e.levels.length-1));t.setLineDash([7,3]),r.drawLevel(t,e.levels[o],50,a,s,h,o==e.levels.length-1?["ðŸ ‰","ðŸ ˆ","ðŸ Š","ðŸ ‹"]:[])}}static drawLevel(t,e,s,r,n,h,o){const a=s+n,l=r+h,{inputs:g,outputs:c,weights:d,biases:f}=e;for(let e=0;e<g.length;e++)for(let n=0;n<c.length;n++)t.beginPath(),t.moveTo(i.getNodeX(g,e,s,a),l),t.lineTo(i.getNodeX(c,n,s,a),r),t.lineWidth=2,t.strokeStyle=i.getRGBA(d[e][n]),t.stroke();for(let e=0;e<g.length;e++){const r=i.getNodeX(g,e,s,a);t.beginPath(),t.arc(r,l,18,0,2*Math.PI),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(r,l,.6*18,0,2*Math.PI),t.fillStyle=i.getRGBA(g[e]),t.fill()}for(let e=0;e<c.length;e++){const n=i.getNodeX(c,e,s,a);t.beginPath(),t.arc(n,r,18,0,2*Math.PI),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(n,r,.6*18,0,2*Math.PI),t.fillStyle=i.getRGBA(c[e]),t.fill(),t.beginPath(),t.lineWidth=2,t.arc(n,r,14.4,0,2*Math.PI),t.strokeStyle=i.getRGBA(f[e]),t.setLineDash([3,3]),t.stroke(),t.setLineDash([]),o[e]&&(t.beginPath(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="black",t.strokeStyle="white",t.font="27px Arial",t.fillText(o[e],n,r+1.8),t.lineWidth=.5,t.strokeText(o[e],n,r+1.8))}}static getNodeX(t,e,s,r){return i.getNodeX(t,e,s,r)}}t.exports=r}},e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={exports:{}};return t[i](r,r.exports,s),r.exports}(()=>{const t=s(533),e=s(621),i=s(857),r=s(338);document.addEventListener("DOMContentLoaded",(function(){document.getElementById("save").addEventListener("click",(function(){localStorage.setItem("bestBrain",JSON.stringify(g.brain))})),document.getElementById("discard").addEventListener("click",(function(){localStorage.removeItem("bestBrain")}));const s=document.querySelector("#car-canvas"),n=document.querySelector("#network-canvas"),h=s.getContext("2d"),o=n.getContext("2d"),a=new e(s.width/2,.9*s.width),l=function(e){const s=[];for(let e=1;e<=1;e++)s.push(new t(a.getLaneCenter(1),100,30,50,"AI"));return s}();let g=l[0];if(localStorage.getItem("bestBrain"))for(let t=0;t<l.length;t++)l[t].brain=JSON.parse(localStorage.getItem("bestBrain")),0!=t&&r.mutate(l[t].brain,.1);const c=[new t(a.getLaneCenter(1),-100,30,50,"DUMMY",2),new t(a.getLaneCenter(0),-300,30,50,"DUMMY",2),new t(a.getLaneCenter(2),-300,30,50,"DUMMY",2),new t(a.getLaneCenter(0),-500,30,50,"DUMMY",2),new t(a.getLaneCenter(1),-500,30,50,"DUMMY",2),new t(a.getLaneCenter(1),-700,30,50,"DUMMY",2),new t(a.getLaneCenter(2),-700,30,50,"DUMMY",2)];!function t(e){for(let t=0;t<c.length;t++)c[t].update(a.borders,[]);for(let t=0;t<l.length;t++)l[t].update(a.borders,c);g=l.find((t=>t.y==Math.min(...l.map((t=>t.y))))),s.height=window.innerHeight,n.height=window.innerHeight,h.save(),h.translate(0,-g.y+.75*s.height),a.draw(h);for(let t=0;t<c.length;t++)c[t].draw(h,"#7bb24d");h.globalAlpha=.2;for(let t=0;t<l.length;t++)l[t].draw(h,"#de6717");h.globalAlpha=1,g.draw(h,"#de6717",!0),h.restore(),o.lineDashOffset=-e/50,i.drawNetwork(o,g.brain),requestAnimationFrame(t)}()}))})()})();
//# sourceMappingURL=car_84610ec2bfeedb3ba1d1.js.map